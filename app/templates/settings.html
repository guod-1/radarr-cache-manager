{% extends "base.html" %}

{% block title %}Settings - Radarr Cache Manager{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <h2 class="text-3xl font-bold text-gray-900 mb-6">Settings</h2>

    <!-- Radarr Connection -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Radarr Connection</h3>
        <form action="/settings/radarr" method="post" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">URL</label>
                <input type="text" name="url" value="{{ settings.radarr.url }}" required
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <p class="mt-1 text-sm text-gray-500">Example: http://192.168.1.100:7878</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">API Key</label>
                <input type="password" name="api_key" value="{{ settings.radarr.api_key }}" required
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex justify-between">
                <button type="submit"
                    class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                    Save Connection
                </button>
                <button type="button" hx-post="/settings/radarr/test" hx-swap="none"
                    class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Test Connection
                </button>
            </div>
        </form>
    </div>

    <!-- Tag Operation -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Tag Operation (Optional)</h3>
        <p class="text-sm text-gray-600 mb-4">Find movies with a specific tag and optionally replace it with another tag.</p>
        <form action="/settings/tags" method="post" class="space-y-4">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Search for Tag ID</label>
                    <select name="search_tag_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        <option value="">-- None --</option>
                        {% for tag in tags %}
                        <option value="{{ tag.id }}" {% if settings.tag_operation.search_tag_id == tag.id %}selected{% endif %}>
                            {{ tag.label }} (ID: {{ tag.id }})
                        </option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-sm text-gray-500">Leave empty to skip tag operations</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Replace with Tag ID (Optional)</label>
                    <select name="replace_tag_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        <option value="">-- Don't Replace --</option>
                        {% for tag in tags %}
                        <option value="{{ tag.id }}" {% if settings.tag_operation.replace_tag_id == tag.id %}selected{% endif %}>
                            {{ tag.label }} (ID: {{ tag.id }})
                        </option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-sm text-gray-500">Leave empty to just find movies</p>
                </div>
            </div>
            <button type="submit"
                class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                Save Tag Settings
            </button>
        </form>
    </div>

    <!-- Exclusion Settings -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Exclusion Settings</h3>
        
        <!-- Output File Info -->
        <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-800">Exclusions Output File</h3>
                    <div class="mt-2 text-sm text-blue-700">
                        <p class="font-mono text-xs bg-white px-2 py-1 rounded border border-blue-200 inline-block">
                            /mnt/user/scripts/mover_exclusions.txt
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <form action="/settings/exclusions" method="post" class="space-y-6">
            <!-- Custom Folders -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Custom Folder Exclusions</label>
                <textarea name="custom_folders" rows="4" 
                    class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 font-mono text-sm"
                    placeholder="/mnt/chloe/data/media/movies/Favorites/&#10;/mnt/chloe/data/media/tv/Kids Shows/">{{ '\n'.join(settings.exclusions.custom_folders) }}</textarea>
                <p class="mt-1 text-sm text-gray-500">One path per line. These folders will always be excluded from mover.</p>
            </div>

            <!-- Tags to Exclude - Improved UI -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Exclude Movies with Tags</label>
                
                <!-- Add Tag Selector -->
                <div class="flex gap-2 mb-3">
                    <select id="tag-selector" class="flex-1 border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        <option value="">-- Select a tag to add --</option>
                        {% for tag in tags %}
                        <option value="{{ tag.id }}" data-label="{{ tag.label }}">
                            {{ tag.label }} (ID: {{ tag.id }})
                        </option>
                        {% endfor %}
                    </select>
                    <button type="button" onclick="addTag()" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                        Add Tag
                    </button>
                </div>

                <!-- Selected Tags List -->
                <div id="selected-tags" class="space-y-2 mb-3">
                    {% for tag_id in settings.exclusions.exclude_tag_ids %}
                    {% set tag_info = tags|selectattr('id', 'equalto', tag_id)|first %}
                    <div class="flex items-center justify-between bg-gray-100 px-3 py-2 rounded-md tag-item" data-tag-id="{{ tag_id }}">
                        <span class="text-sm">
                            <strong>{{ tag_info.label if tag_info else 'Unknown' }}</strong> (ID: {{ tag_id }})
                        </span>
                        <button type="button" onclick="removeTag({{ tag_id }})" 
                            class="text-red-600 hover:text-red-800 text-sm font-medium">
                            Remove
                        </button>
                    </div>
                    {% endfor %}
                </div>

                <!-- Hidden input to store tag IDs -->
                <input type="hidden" name="exclude_tag_ids" id="exclude-tag-ids" value="{{ ','.join(settings.exclusions.exclude_tag_ids|map('string')) }}">
                
                <p class="text-sm text-gray-500">Movies with these tags will be added to exclusions.</p>
            </div>

            <!-- PlexCache-D File -->
            <div>
                <label class="block text-sm font-medium text-gray-700">PlexCache-D Exclusions File Path</label>
                <input type="text" name="plexcache_file_path" value="{{ settings.exclusions.plexcache_file_path }}"
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 font-mono text-sm">
                <p class="mt-1 text-sm text-gray-500">Path to PlexCache-D's unraid_mover_exclusions.txt file</p>
            </div>

            <button type="submit"
                class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                Save Exclusion Settings
            </button>
        </form>
    </div>

    <!-- Scheduler -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Scheduler</h3>
        <form action="/settings/scheduler" method="post" class="space-y-4">
            <div class="flex items-center">
                <input type="checkbox" name="enabled" value="true" {% if settings.scheduler.enabled %}checked{% endif %}
                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label class="ml-2 block text-sm text-gray-900">Enable automatic runs</label>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Cron Expression</label>
                <input type="text" name="cron_expression" value="{{ settings.scheduler.cron_expression }}" required
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                <p class="mt-1 text-sm text-gray-500">Example: "0 */6 * * *" = every 6 hours</p>
            </div>
            <button type="submit"
                class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                Save Scheduler
            </button>
        </form>
    </div>
</div>

<script>
    function addTag() {
        const selector = document.getElementById('tag-selector');
        const tagId = selector.value;
        const tagLabel = selector.options[selector.selectedIndex].dataset.label;
        
        if (!tagId) return;
        
        // Check if already added
        if (document.querySelector(`.tag-item[data-tag-id="${tagId}"]`)) {
            alert('This tag is already added');
            return;
        }
        
        // Add to list
        const tagsList = document.getElementById('selected-tags');
        const tagItem = document.createElement('div');
        tagItem.className = 'flex items-center justify-between bg-gray-100 px-3 py-2 rounded-md tag-item';
        tagItem.dataset.tagId = tagId;
        tagItem.innerHTML = `
            <span class="text-sm">
                <strong>${tagLabel}</strong> (ID: ${tagId})
            </span>
            <button type="button" onclick="removeTag(${tagId})" 
                class="text-red-600 hover:text-red-800 text-sm font-medium">
                Remove
            </button>
        `;
        tagsList.appendChild(tagItem);
        
        // Update hidden input
        updateHiddenInput();
        
        // Reset selector
        selector.value = '';
    }
    
    function removeTag(tagId) {
        const tagItem = document.querySelector(`.tag-item[data-tag-id="${tagId}"]`);
        if (tagItem) {
            tagItem.remove();
            updateHiddenInput();
        }
    }
    
    function updateHiddenInput() {
        const tagItems = document.querySelectorAll('.tag-item');
        const tagIds = Array.from(tagItems).map(item => item.dataset.tagId);
        document.getElementById('exclude-tag-ids').value = tagIds.join(',');
    }
    
    // HTMX success handler
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.successful) {
            const url = event.detail.xhr.responseURL;
            if (url.includes('/settings/radarr/test')) {
                const response = JSON.parse(event.detail.xhr.responseText);
                alert(response.message);
            }
        }
    });
</script>
{% endblock %}
