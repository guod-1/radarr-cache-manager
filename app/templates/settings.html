{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto space-y-8 pb-12">
    <div>
        <h1 class="text-3xl font-bold text-white tracking-tight">System Configuration</h1>
        <p class="text-gray-400 mt-1">Configure your service connections, paths, and automation schedules</p>
    </div>

    <!-- Service Connections -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Radarr -->
        <div class="bg-gray-800 rounded-xl border border-gray-700 shadow-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-700 flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-yellow-500/10 border border-yellow-500/20 flex items-center justify-center">
                    <i class="fa-solid fa-film text-yellow-400 text-xs"></i>
                </div>
                <h2 class="text-lg font-semibold text-white">Radarr</h2>
                {% if request.query_params.get("radarr_status") == "success" %}
                <span class="ml-auto text-[10px] font-bold uppercase tracking-widest text-green-400 bg-green-950/40 px-2 py-1 rounded border border-green-900/50">● Connected</span>
                {% elif request.query_params.get("radarr_status") == "error" %}
                <span class="ml-auto text-[10px] font-bold uppercase tracking-widest text-red-400 bg-red-950/40 px-2 py-1 rounded border border-red-900/50">✗ Failed</span>
                {% endif %}
            </div>
            <div class="p-6">
                <form action="/settings/radarr/save" method="POST" class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">URL</label>
                        <input type="text" name="url" value="{{ settings.radarr.url }}" placeholder="http://192.168.1.x:7878" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white text-sm font-mono outline-none focus:ring-1 focus:ring-yellow-500/50 focus:border-yellow-500/50">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">API Key</label>
                        <input type="password" name="api_key" value="{{ settings.radarr.api_key }}" placeholder="••••••••••••••••••••" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white text-sm outline-none focus:ring-1 focus:ring-yellow-500/50 focus:border-yellow-500/50">
                    </div>
                    <button type="submit" class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-white font-bold transition shadow-lg shadow-black/30 mt-2">Save &amp; Test</button>
                </form>
            </div>
        </div>

        <!-- Sonarr -->
        <div class="bg-gray-800 rounded-xl border border-gray-700 shadow-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-700 flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-blue-500/10 border border-blue-500/20 flex items-center justify-center">
                    <i class="fa-solid fa-tv text-blue-400 text-xs"></i>
                </div>
                <h2 class="text-lg font-semibold text-white">Sonarr</h2>
                {% if request.query_params.get("sonarr_status") == "success" %}
                <span class="ml-auto text-[10px] font-bold uppercase tracking-widest text-green-400 bg-green-950/40 px-2 py-1 rounded border border-green-900/50">● Connected</span>
                {% elif request.query_params.get("sonarr_status") == "error" %}
                <span class="ml-auto text-[10px] font-bold uppercase tracking-widest text-red-400 bg-red-950/40 px-2 py-1 rounded border border-red-900/50">✗ Failed</span>
                {% endif %}
            </div>
            <div class="p-6">
                <form action="/settings/sonarr/save" method="POST" class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">URL</label>
                        <input type="text" name="url" value="{{ settings.sonarr.url }}" placeholder="http://192.168.1.x:8989" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white text-sm font-mono outline-none focus:ring-1 focus:ring-blue-500/50 focus:border-blue-500/50">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">API Key</label>
                        <input type="password" name="api_key" value="{{ settings.sonarr.api_key }}" placeholder="••••••••••••••••••••" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white text-sm outline-none focus:ring-1 focus:ring-blue-500/50 focus:border-blue-500/50">
                    </div>
                    <button type="submit" class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-white font-bold transition shadow-lg shadow-black/30 mt-2">Save &amp; Test</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Paths & Automation -->
    <div class="bg-gray-800 rounded-xl border border-gray-700 shadow-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-700 flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-primary-500/10 border border-primary-500/20 flex items-center justify-center">
                <i class="fa-solid fa-clock text-primary-400 text-xs"></i>
            </div>
            <h2 class="text-lg font-semibold text-white">Paths &amp; Automation</h2>
            {% if request.query_params.get('status') == 'success' %}
            <span class="ml-auto text-[10px] font-bold uppercase tracking-widest text-green-400 bg-green-950/40 px-2 py-1 rounded border border-green-900/50">● Settings Saved</span>
            {% endif %}
        </div>
        <div class="p-6">
            <form action="/settings/paths/save" method="POST" class="space-y-8">

                <!-- Schedules -->
                <div>
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <span class="w-4 h-px bg-gray-600"></span> Schedules <span class="flex-1 h-px bg-gray-700"></span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700/50">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Exclusion Builder</label>
                            <p class="text-[10px] text-teal-500 font-mono mb-2">Last Run: {{ settings.exclusions.last_build or "Never" }}</p>
                            <input type="text" name="full_sync_cron" value="{{ settings.exclusions.full_sync_cron }}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white font-mono text-xs outline-none focus:ring-1 focus:ring-primary-500">
                            <p class="text-[10px] text-gray-500 mt-2 italic">Triggers Radarr/Sonarr scan and rebuilds the exclusion file.</p>
                        </div>
                        <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700/50">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Log Monitor</label>
                            <p class="text-[10px] text-teal-500 font-mono mb-2">Last Run: {{ settings.exclusions.last_stats_update or "Never" }}</p>
                            <input type="text" name="log_monitor_cron" value="{{ settings.exclusions.log_monitor_cron }}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white font-mono text-xs outline-none focus:ring-1 focus:ring-primary-500">
                            <p class="text-[10px] text-gray-500 mt-2 italic">Scans mover log to refresh stats. e.g. <span class="font-mono not-italic text-gray-400">*/5 * * * *</span></p>
                        </div>
                    </div>
                </div>

                <!-- Cache & Logs -->
                <div>
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <span class="w-4 h-px bg-gray-600"></span> Cache &amp; Logs <span class="flex-1 h-px bg-gray-700"></span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700/50">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Cache Mount Point</label>
                            <input type="text" name="cache_mount_path" value="{{ settings.exclusions.cache_mount_path }}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white font-mono text-xs outline-none focus:ring-1 focus:ring-primary-500">
                            <p class="text-[10px] text-gray-500 mt-2 italic">Where your cache drive is mounted <strong class="text-gray-400">inside this container</strong>. Used only to verify files exist on cache — never written to the output file.</p>
                        </div>
                        <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700/50">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Mover Tuning Log Path</label>
                            <input type="text" name="ca_mover_log_path" value="{{ settings.exclusions.ca_mover_log_path }}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white font-mono text-xs outline-none focus:ring-1 focus:ring-primary-500">
                            <p class="text-[10px] text-gray-500 mt-2 italic">CA Mover Tuning log path inside this container. Map your Unraid <span class="font-mono text-yellow-500 not-italic">/boot/logs/</span> directory here.</p>
                        </div>
                    </div>
                </div>

                <!-- Media Paths -->
                <div>
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <span class="w-4 h-px bg-gray-600"></span> Media Paths <span class="flex-1 h-px bg-gray-700"></span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700/50">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Movie Base Path <span class="text-gray-600 normal-case font-normal">(host)</span></label>
                            <input type="text" name="movie_base_path" value="{{ settings.exclusions.movie_base_path }}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white font-mono text-xs outline-none focus:ring-1 focus:ring-primary-500">
                            <p class="text-[10px] text-gray-500 mt-2 italic">Root movie folder on the Unraid host. Used for display and stats only.</p>
                        </div>
                        <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700/50">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">TV Base Path <span class="text-gray-600 normal-case font-normal">(host)</span></label>
                            <input type="text" name="tv_base_path" value="{{ settings.exclusions.tv_base_path }}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white font-mono text-xs outline-none focus:ring-1 focus:ring-primary-500">
                            <p class="text-[10px] text-gray-500 mt-2 italic">Root TV folder on the Unraid host. Used for display and stats only.</p>
                        </div>
                    </div>
                </div>

                <!-- Path Mappings -->
                <div>
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-1 flex items-center gap-2">
                        <span class="w-4 h-px bg-gray-600"></span> Path Mappings <span class="flex-1 h-px bg-gray-700"></span>
                    </h3>
                    <p class="text-[10px] text-gray-500 mb-4 italic">
                        Each service stores file paths using its own internal container mount. Before writing to the exclusion file,
                        the app rewrites those prefixes so CA Mover sees the correct path on your Unraid host.
                        <br><span class="text-gray-400 not-italic">
                            <strong class="text-yellow-500">API Prefix</strong> = what the service returns.
                            <strong class="text-teal-400">Host Prefix</strong> = what gets written to the exclusion file — must match the path as your Unraid host sees it (e.g. <span class="font-mono">/mnt/cache/...</span>).
                        </span>
                    </p>

                    <div class="space-y-3">
                        <!-- Radarr -->
                        <div class="bg-gray-900/50 rounded-lg border border-gray-700/50 p-4">
                            <div class="flex items-center gap-2 mb-3">
                                <div class="w-6 h-6 rounded bg-yellow-500/10 border border-yellow-500/20 flex items-center justify-center">
                                    <i class="fa-solid fa-film text-yellow-400 text-[10px]"></i>
                                </div>
                                <span class="text-sm font-bold text-white">Radarr</span>
                                <span class="text-[10px] text-gray-500 italic ml-1">— tagged movie exclusions</span>
                                <button type="button" onclick="detectSingle('radarr')" class="ml-auto text-[10px] bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded transition font-bold shadow shadow-black/30">⟳ Detect</button>
                            </div>
                            <div class="flex gap-2 items-end">
                                <div class="flex-1">
                                    <label class="block text-[10px] text-yellow-500 font-bold uppercase mb-1">API Prefix <span class="text-gray-500 font-normal normal-case">(what Radarr returns)</span></label>
                                    <input type="text" id="radarr_from_input" name="radarr_from" value="{{ settings.exclusions.radarr_mapping.from_prefix }}" placeholder="/data/" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white font-mono text-xs outline-none focus:ring-1 focus:ring-yellow-500/50">
                                </div>
                                <span class="text-gray-500 text-sm shrink-0 pb-2">→</span>
                                <div class="flex-1">
                                    <label class="block text-[10px] text-teal-400 font-bold uppercase mb-1">Host Prefix <span class="text-gray-500 font-normal normal-case">(written to exclusion file)</span></label>
                                    <input type="text" name="radarr_to" value="{{ settings.exclusions.radarr_mapping.to_prefix }}" placeholder="/mnt/cache/data/" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white font-mono text-xs outline-none focus:ring-1 focus:ring-teal-500/50">
                                </div>
                            </div>
                        </div>

                        <!-- Sonarr -->
                        <div class="bg-gray-900/50 rounded-lg border border-gray-700/50 p-4">
                            <div class="flex items-center gap-2 mb-3">
                                <div class="w-6 h-6 rounded bg-blue-500/10 border border-blue-500/20 flex items-center justify-center">
                                    <i class="fa-solid fa-tv text-blue-400 text-[10px]"></i>
                                </div>
                                <span class="text-sm font-bold text-white">Sonarr</span>
                                <span class="text-[10px] text-gray-500 italic ml-1">— tagged TV show exclusions</span>
                                <button type="button" onclick="detectSingle('sonarr')" class="ml-auto text-[10px] bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded transition font-bold shadow shadow-black/30">⟳ Detect</button>
                            </div>
                            <div class="flex gap-2 items-end">
                                <div class="flex-1">
                                    <label class="block text-[10px] text-yellow-500 font-bold uppercase mb-1">API Prefix <span class="text-gray-500 font-normal normal-case">(what Sonarr returns)</span></label>
                                    <input type="text" id="sonarr_from_input" name="sonarr_from" value="{{ settings.exclusions.sonarr_mapping.from_prefix }}" placeholder="/data/" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white font-mono text-xs outline-none focus:ring-1 focus:ring-yellow-500/50">
                                </div>
                                <span class="text-gray-500 text-sm shrink-0 pb-2">→</span>
                                <div class="flex-1">
                                    <label class="block text-[10px] text-teal-400 font-bold uppercase mb-1">Host Prefix <span class="text-gray-500 font-normal normal-case">(written to exclusion file)</span></label>
                                    <input type="text" name="sonarr_to" value="{{ settings.exclusions.sonarr_mapping.to_prefix }}" placeholder="/mnt/cache/data/" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white font-mono text-xs outline-none focus:ring-1 focus:ring-teal-500/50">
                                </div>
                            </div>
                        </div>

                        <!-- PlexCache -->
                        <div class="bg-gray-900/50 rounded-lg border border-gray-700/50 p-4">
                            <div class="flex items-center gap-2 mb-3">
                                <div class="w-6 h-6 rounded bg-orange-500/10 border border-orange-500/20 flex items-center justify-center">
                                    <i class="fa-solid fa-database text-orange-400 text-[10px]"></i>
                                </div>
                                <span class="text-sm font-bold text-white">PlexCache</span>
                                <span class="text-[10px] text-gray-500 italic ml-1">— PlexCache pinned media exclusions</span>
                                <button type="button" onclick="detectSingle('plexcache')" class="ml-auto text-[10px] bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded transition font-bold shadow shadow-black/30">⟳ Detect</button>
                            </div>
                            <div class="flex gap-2 items-end">
                                <div class="flex-1">
                                    <label class="block text-[10px] text-yellow-500 font-bold uppercase mb-1">API Prefix <span class="text-gray-500 font-normal normal-case">(what PlexCache returns)</span></label>
                                    <input type="text" id="plexcache_from_input" name="plexcache_from" value="{{ settings.exclusions.plexcache_mapping.from_prefix }}" placeholder="/chloe/" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white font-mono text-xs outline-none focus:ring-1 focus:ring-yellow-500/50">
                                </div>
                                <span class="text-gray-500 text-sm shrink-0 pb-2">→</span>
                                <div class="flex-1">
                                    <label class="block text-[10px] text-teal-400 font-bold uppercase mb-1">Host Prefix <span class="text-gray-500 font-normal normal-case">(written to exclusion file)</span></label>
                                    <input type="text" name="plexcache_to" value="{{ settings.exclusions.plexcache_mapping.to_prefix }}" placeholder="/mnt/cache/data/media/" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white font-mono text-xs outline-none focus:ring-1 focus:ring-teal-500/50">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end pt-2 border-t border-gray-700">
                    <button type="submit" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2.5 px-10 rounded-lg transition shadow-lg shadow-black/30">Save All System Settings</button>
                </div>
            </form>

            <script>
            function showToast(msg, type='success') {
                const t = document.createElement('div');
                t.className = `fixed bottom-6 right-6 z-50 px-4 py-3 rounded-lg text-sm font-bold shadow-xl transition-all duration-300 ${type === 'success' ? 'bg-green-900 border border-green-700 text-green-300' : 'bg-red-900 border border-red-700 text-red-300'}`;
                t.textContent = msg;
                document.body.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            }

            async function detectSingle(service) {
                const btn = event.target;
                const orig = btn.innerHTML;
                btn.innerHTML = '<span class="animate-spin inline-block">⟳</span> Detecting...';
                btn.disabled = true;
                try {
                    const res = await fetch('/settings/path-prefixes');
                    const data = await res.json();
                    const input = document.getElementById(service + '_from_input');
                    const key = service.charAt(0).toUpperCase() + service.slice(1);
                    if (data[key] && !data[key].startsWith('Error') && input) {
                        input.value = data[key];
                        input.style.transition = 'border-color 0.2s';
                        input.style.borderColor = '#22c55e';
                        setTimeout(() => input.style.borderColor = '', 2000);
                        showToast(`✓ ${key} prefix detected: ${data[key]}`, 'success');
                    } else {
                        showToast(`✗ Could not detect ${key} prefix`, 'error');
                    }
                } catch(e) {
                    showToast('Detection failed: ' + e, 'error');
                } finally {
                    btn.innerHTML = orig;
                    btn.disabled = false;
                }
            }
            </script>
        </div>
    </div>
</div>
{% endblock %}
